@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
}



@{
    ViewBag.Title = "Home Page";
}


<link rel="stylesheet" href="/css/dashboard.css" />

<main class="d-flex flex-nowrap">
<div id="sidebarLink" class="d-flex flex-column flex-shrink-0 p-3 bg-body-tertiary"
     style="width: 280px; height: 90vh">
    <ul class="nav nav-pills flex-column mb-auto">
        <li class="nav-item">
            <a href="#"
               class="nav-link "
               aria-current="page"
               onclick="showDiv('orderDiv')">
                <svg class="bi pe-none me-2" width="16" height="16">
                    <use xlink:href="#home" />
                </svg>
                Your orders
            </a>
        </li>
        <li>
            <a href="#"
               class="nav-link link-body-emphasis"
               onclick="showDiv('settingDiv')">
                <svg class="bi pe-none me-2" width="16" height="16">
                    <use xlink:href="#speedometer2" />
                </svg>
                Settings
            </a>
        </li>
   @*      <li>
            <a href="#" class="nav-link link-body-emphasis" onclick="showDiv('statDiv')">
                <svg class="bi pe-none me-2" width="16" height="16">
                    <use xlink:href="#table" />
                </svg>
                Stats
            </a>
        </li> *@
        <li>
            <a href="#" class="nav-link active link-body-emphasis" onclick="showDiv('accountDiv')">
                <svg class="bi pe-none me-2" width="16" height="16">
                    <use xlink:href="#grid" />
                </svg>
                Account Details
            </a>
        </li>
        <li>
            <hr />
            <a href="#" class="nav-link link-body-emphasis" id="logoutBtn">
                <svg xmlns="http://www.w3.org/2000/svg"
                     width="14"
                     height="14"
                     viewBox="0 0 24 24"
                     fill="none"
                     stroke="currentColor"
                     stroke-width="2"
                     stroke-linecap="round"
                     stroke-linejoin="round"
                     class="me-2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
                Logout
            </a>
        </li>
    </ul>
</div>
<div class="mainContainer">
    <div class=" content rightBox p-4 bg-light" id="orderDiv" style="height: 100vh;">
        <h2 class="mb-4">Your Orders</h2>
     
        
        <table class="table">
            <thead "class="bg-light">

                <th>Product</th>
                <th>Name</th>
                <th>Order Id</th>
                <th>Date</th>
                <th>Items</th>
                <th>Status</th>
                <th>Amount</th>

            </thead>    
            <tbody id="orderTableBody">
            
            </tbody>
        </table>
                    <div id="paginationControls" class="mt-3 text-center"></div>
       
    </div>
        <div class="content rightBox  bg-light p-4" id="settingDiv">

            <div id="CustomerUpdateDetails" class="content-div ">
                <h3>Edit Profile</h3>
                <form class="row g-3">
                    <div class="col-md-5">
                        <label for="txtCustomerId" class="form-label"> User Id</label>
                        <input type="number" class="form-control" id="txtCustomerId" placeholder="User Id ">
                    </div>
                    <div class="col-md-5">
                        <label for="txtFirstName" class="form-label">First Name</label>
                        <input type="text" class="form-control" id="txtFirstName" placeholder="First Name">
                    </div>
                    <div class="col-md-5">
                        <label for="txtLastName" class="form-label">Last Name</label>
                        <input type="text" class="form-control" id="txtLastName" placeholder="Last Name">
                    </div>
                    <div class="col-md-5">
                        <label for="txtUserEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="txtUserEmail" placeholder="Email">
                    </div>
                    <div class="col-md-5">
                        <label for="txtUserPassword" class="form-label">Password</label>
                        <input type="password" class="form-control" id="txtUserPassword" placeholder="Password">
                    </div>
                    <div class="col-md-5">
                        <label for="txtUserAddress" class="form-label">Address</label>
                        <input type="text" class="form-control" id="txtUserAddress" placeholder="Apartment, studio, or floor">
                    </div>
                    <div class="col-md-5">
                        <label for="ContactNumber" class="form-label">Contact Number</label>
                        <input type="tel" class="form-control" id="ContactNumber" placeholder="Contact No">
                    </div>
                    <div class="col-md-5">
                        <label for="CustomerRole" class="form-label">Select User Role</label>
                        <select id="CustomerRole" class="form-select">
                            <option selected>Customer</option>
                            <option>Sales</option>
                        </select>
                    </div>
                    <div class="col-12">
                        <button type="button" class="btn btn-info" id="SubmitEditedProfile">Edit</button>
                    </div>
                </form>
            </div>


    </div>
    <div class="content rightBox" id="statDiv">
    </div>
        <div class="active content rightBox" id="accountDiv">

    </div>
</div>
</main>


<script src="~/lib/jquery/dist/jquery.min.js"></script>
<script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js" type="text/javascript"></script>





<script>
    // Variables to keep track of current page, items per page, and orders
    let currentPage = 1;
    const itemsPerPage = 5; // Set the number of items per page
    let orders = []; // Global orders variable to store the fetched data

    // Function to populate the orders table
    function populateOrdersTable() {
        let html = "";
        const totalOrders = orders.length;
        const totalPages = Math.ceil(totalOrders / itemsPerPage);

        // Calculate the start and end indices for the current page
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;

        // Slice the orders array to show only the orders for the current page
        const ordersToShow = orders.slice(startIndex, endIndex);

        // Generate table rows for the current page's orders
        ordersToShow.forEach(order => {
            html += `
                    <tr>
                        <td><img src="${order.imageUrl}" class="img-thumbnail" style="height: 50px; width: 50px;" /></td>
                        <td>${order.title}</td>
                        <td>${order.orderId}</td>
                        <td>${order.orderDate}</td>
                        <td>${order.quantity}</td>
                        <td>${order.orderStatus}</td>
                        <td>${order.price}</td>
                    </tr>
                `;
        });

        // Insert the rows into the table body
        $("#orderTableBody").html(html);

        // Generate pagination controls
        generatePaginationControls(totalPages);
    }

    // Function to generate pagination controls
    function generatePaginationControls(totalPages) {
        let paginationHtml = "";

        // Previous button
        paginationHtml += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                                <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Previous</a>
                               </li>`;

        // Page number buttons
        for (let page = 1; page <= totalPages; page++) {
            paginationHtml += `<li class="page-item ${currentPage === page ? 'active' : ''}">
                                    <a class="page-link" href="#" onclick="changePage(${page})">${page}</a>
                                   </li>`;
        }

        // Next button
        paginationHtml += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                                <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a>
                               </li>`;

        // Insert pagination controls into the DOM
        $("#paginationControls").html(`
                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-center">
                        ${paginationHtml}
                    </ul>
                </nav>
            `);
    }

    // Function to change the page
    function changePage(page) {
        if (page < 1 || page > Math.ceil(orders.length / itemsPerPage)) return; // Prevent invalid page numbers
        currentPage = page;
        populateOrdersTable(); // Re-populate the table for the new page
    }

    // Function to handle logout
    function handleLogout() {
        localStorage.clear();
        alert("You are logged out!");
        window.location.href = "/auth/login";
    }

    // Function to show the appropriate div based on the id
    function showDiv(divId) {
        // Hide all divs
        const divs = document.querySelectorAll(".content");
        divs.forEach(div => div.classList.remove("active"));

        // Show the selected div
        const selectedDiv = document.getElementById(divId);
        if (selectedDiv) {
            selectedDiv.classList.add("active");
        }
    }

    // Function to render user details card
    function renderUserCard(user) {
        const cardHtml = `
                <div class="container mt-5">
                    <div class="card" style="max-width: 600px; margin: auto;">
                        <div class="card-header">
                            <h3>Account Details</h3>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-6"><strong>First Name:</strong><p>${user.firstName}</p></div>
                                <div class="col-6"><strong>Last Name:</strong><p>${user.lastName}</p></div>
                            </div>
                            <div class="row"><div class="col-12"><strong>Email:</strong><p>${user.email}</p></div></div>
                            <div class="row"><div class="col-12"><strong>Address:</strong><p>${user.address}</p></div></div>
                            <div class="row"><div class="col-12"><strong>Contact Number:</strong><p>${user.contactNumber}</p></div></div>
                            <div class="row"><div class="col-12"><strong>Role:</strong><p>${user.role}</p></div></div>
                        </div>
                        <div class="card-footer text-muted">Last updated: 10/11/2024</div>
                    </div>
                </div>
            `;
        $("#accountDiv").html(cardHtml);
    }

    // Function to populate user form fields
    function populateUserForm(user) {
        $("#txtCustomerId").val(user.id);
        $("#txtFirstName").val(user.firstName);
        $("#txtLastName").val(user.lastName);
        $("#txtUserEmail").val(user.email); // Fixed extra space
        $("#txtUserPassword").val(user.password);
        $("#txtUserAddress").val(user.address);
        $("#ContactNumber").val(user.contactNumber);
        $("#CustomerRole").val(user.role);
    }

    // Initialize the page when the DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
        // Handle sidebar navigation item clicks
        const items = document.querySelectorAll("#sidebarLink ul .nav-link");
        items.forEach(item => {
            item.addEventListener('click', function () {
                // Remove active class from all sidebar items
                items.forEach(i => i.classList.remove('active'));
                // Add active class to the clicked item
                this.classList.add('active');
            });
        });

        // Make a single AJAX call to fetch user and order data
        const userId = localStorage.getItem("userId");
        const getOrderUrl = `http://localhost:5218/api/orders/customer/${userId}`;
        const getUserUrl = `http://localhost:5218/api/bi/getcustomer/${userId}`;
        const token = localStorage.getItem("token");
        if (userId == null || token == null) {
            alert("please login first");
            window.location.href = "/auth/login";
        }

        // Fetch user and order data using Promise.all to handle both requests simultaneously
        Promise.all([
            $.ajax({
                url: getOrderUrl, headers: {
                    'contentType': "application/json",
                    'Authorization': `Bearer ${token}`
                }, type: "GET"
            }),
            $.ajax({
                url: getUserUrl, headers: {
                    'contentType': "application/json",
                    'Authorization': `Bearer ${token}`
                }, type: "GET"
            })
        ])
            .then(([ordersData, user]) => {
                orders = ordersData; // Save the fetched orders globally
                populateOrdersTable(); // Populate the orders table
                renderUserCard(user); // Render the user card
                populateUserForm(user); // Populate user form
            })
            .catch(err => console.log("Error fetching data", err));

        // Initialize tooltips for any elements with the 'data-bs-toggle="tooltip"' attribute
        (() => {
            const tooltipTriggerList = Array.from(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.forEach(tooltipTriggerEl => {
                new bootstrap.Tooltip(tooltipTriggerEl);
            });
        })();

        // Logout button click event listener
        $("#logoutBtn").click(handleLogout);
    });
</script>




                