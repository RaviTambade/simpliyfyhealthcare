<h3>Orders for SalesPerson</h3>

<div class="container mt-4">
    <h1 class="text-center">Order Details for Salesperson</h1>

    <!-- List of Orders -->
    <table class="table">
        <thead>
            <tr>
                <th>Order ID</th>
                <th>Customer Name</th>
                <th>Total</th>
                <th>Date</th>
                <th>Status</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="ordersList">
            <!-- Orders will be appended here -->
        </tbody>
    </table>
</div>

<script src="~/lib/jquery/dist/jquery.min.js"></script>

<script>

    // Function to create an order row HTML structure

    function createOrderRow(order, customerName) {

        return `
    <tr id="order-${order.id}" class="order-row" data-order-id="${order.id}">
    <td>${order.id}</td>
    <td>${customerName}</td>
    <td>$${order.totalAmount.toFixed(2)}</td>
    <td>${new Date(order.orderDate).toLocaleDateString()}</td>
    <td>
    <select class="form-select status-dropdown" id="status${order.id}" onchange="changeStatus(${order.id}, new Date('${order.orderDate}'), ${order.customerId}, ${order.totalAmount})">
    <option value="Pending" ${order.status === 'Pending' ? 'selected' : ''}>Pending</option>
    <option value="Completed" ${order.status === 'Completed' ? 'selected' : ''}>Completed</option>
    <option value="Cancelled" ${order.status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
    </select>
    </td>
    <td>
    <button class="btn btn-info btn-sm view-details-btn" onclick="OnDetailsClick(${order.id})">View More Details</button>
    </td>
    </tr>

                `;

    }

    // Fetch orders for the salesperson

    function fetchOrders() {

        $.ajax({

            url: 'http://localhost:5218/api/Orders',

            method: 'GET',

            dataType: 'json',

            success: function (orders) {

                $('#ordersList').empty();

                if (orders && orders.length > 0) {

                    orders.forEach(function (order) {

                        fetchCustomerName(order.customerId, function (customerName) {

                            var orderRow = createOrderRow(order, customerName);

                            $('#ordersList').append(orderRow);

                        });

                    });

                } else {

                    $('#ordersList').append('<tr><td colspan="6">No orders found</td></tr>');

                }



            },

            error: function () {

                alert('Failed to load orders');

            }

        });

    }

    function OnDetailsClick(orderid) {

        window.location.href = `/Orders/SalesViewDetails?orderId=${orderid}`;

        console.log("Clicked");

    }

    // Fetch customer name by customer ID

    function fetchCustomerName(customerId, callback) {

        $.ajax({

            url: `http://localhost:5218/api/users/${customerId}`,

            method: 'GET',

            dataType: 'json',

            success: function (customer) {

                callback(customer.firstName + " " + customer.lastName);

            },

            error: function () {

                alert('Failed to load customer details');

                callback('Unknown Customer');

            }

        });

    }

    // Update order status via API

    function changeStatus(orderId, orderDate, customerId, totalAmount) {

        var status = $('#status' + orderId).val();

        var context = {

            Id: orderId,

            CustomerId: customerId,

            Status: status,

            OrderDate: orderDate,

            TotalAmount: totalAmount

        };

        $.ajax({

            url: `http://localhost:5218/api/Orders/${orderId}`,

            type: 'PUT',

            contentType: 'application/json',

            data: JSON.stringify(context),

            success: function () {

                alert(`Order #${orderId} status updated to ${status}`);

            },

            error: function () {

                alert('Failed to update order status');

            }

        });

    }

    $(document).ready(function () {

        fetchOrders();

    });
</script>

